---
- name: add temporary mount point
  file:
    path: "{{ aur_work_dir }}"
    mode: 0755
    state: directory

- command: mountpoint -q "{{ aur_work_dir }}"
  register: aur_tmp_mount
  failed_when: false
  changed_when: false

- name: mount temporary tmpfs
  command: >
    mount -t tmpfs -o
    nodev,nosuid,exec,noatime,uid={{ ansible_env.SUDO_UID }},mode=0755
    tmpfs {{ aur_work_dir }}
  args:
    warn: false
  changed_when: false
  when: aur_tmp_mount.rc != 0

- name: install dependencies
  pacman:
    name: base-devel
    update_cache: true

- name: install aur packages
  makepkg:
    name: "{{ item.pkg | default('') }}"
    state: present
    as_deps: "{{ item.dep | default(false) }}"
    build_dir: "{{ aur_work_dir }}"
  with_items: "{{ aur.install | default(aur_default_install) }}"

- name: cleanup mountpoint
  command: umount "{{ aur_work_dir }}"
  args:
    warn: false
  changed_when: false
